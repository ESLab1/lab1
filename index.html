<!doctype html>
<html>

<head>
    <title>Chat room</title>
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" type="text/css" href="tooltipster.bundle.min.css" />
</head>

<body id="body">
    <div id="message_block">
        <section id="message_header">
            <h2>聊天室 chat room</h2>
        </section>
        <section id="message_history">
            <div id="messages"></div>
        </section>
        <section id="message_type">
            <form id="textbox">
                <input id="m" autocomplete="off" /><button>Send</button>
            </form>
        </section>
    </div>
    <div id="onlinelist">
        <h2 id="members">在線名單</h2>
        <ul id="userlist"></ul>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script type="text/javascript" src="tooltipster.bundle.min.js"></script>
    <script>
        $(function() { //for client
            var socket = io();
            var name;

            login();

            //delete cookie
            // document.cookie = "loggedIn=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";


            //if already logged in
            /*
            document.cookie = "loggedIn=1; path=/"; //write
            document.cookie = "iAmBoy=1; path=/";
            */

            /*
            loggedIn = getCookie("loggedIn");
            iAmBoy = getCookie("iAmBoy");

            function getCookie(cname) { //read
                var name = cname + "=";
                var decodedCookie = decodeURIComponent(document.cookie);
                var ca = decodedCookie.split(';');
                for(var i = 0; i <ca.length; i++) {
                    var c = ca[i];
                    while (c.charAt(0) == ' ') {
                        c = c.substring(1);
                    }
                    if (c.indexOf(name) == 0) {
                        return c.substring(name.length, c.length);
                    }
                }
                return "";
            }
            */
            function getCookie(cname) { //read
                var name = cname + "=";
                var decodedCookie = decodeURIComponent(document.cookie);
                var ca = decodedCookie.split(';');
                for (var i = 0; i < ca.length; i++) {
                    var c = ca[i];
                    while (c.charAt(0) == ' ') {
                        c = c.substring(1);
                    }
                    if (c.indexOf(name) == 0) {
                        return c.substring(name.length, c.length);
                    }
                }
                return "";
            }

            $('#textbox').submit(function() {
                if ($('#m').val() != '') {
                    socket.emit('chat message', $('#m').val()); //display message
                    $('#m').val(''); // clean input
                }
                return false;
            });

            socket.on('relogin', function() {
                if (getCookie(loggdeIn)) {
                    //refresh only, not relogin
                } else {
                    alert("此帳號已從別處登入，請用其他帳號重新登入！");
                    login();
                }
            });

            socket.on('wrong password', function() {
                alert("密碼錯誤，請重新登入！");
                login();
            });

            socket.on('chat message', function(data) {
                //appendMessage(data.username+":"+data.msg);
                AppendMessage(data);
            });

            socket.on('onetoone chat', function(user2) {

                //var body = document.getElementById("body");
                var tmp_body = document.getElementById("message_block");

                var newdiv = document.createElement("div");
                var header = document.createElement("h3");
                var content = document.createElement("section");

                newdiv.innerHTML = '<div class="private_chat"></div>';
                header.innerHTML = '<h3>' + user2 + '</h3>';
                content.innerHTML = '<div></div></section><section><form id = "abc"><input id="pri" autocomplete="off"/><button>Send</button></form>';
                //has bug here
                newdiv.appendChild(header);
                newdiv.appendChild(content);
                tmp_body.appendChild(newdiv);

            });


            socket.on('add record', function(data) {
                //appendMessage(data.u_name+":"+data.u_word);
                AppendMessage(data);
            });

            socket.on('set guestnum', function(num) {
                if (num != 1)
                    name += num;
            });

            socket.on('update userlist', function(userlist) {
                updateuserlist(userlist);
            });

            socket.on('add user', function(data) {
                appendnotice(data.username + "已加入");
            });

            socket.on('user left', function(data) {
                appendnotice(data.username + "已離開");
                //delete cookie
                //document.cookie = "loggedIn=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                //document.cookie = "loggedIn=0; path=/";
                document.cookie = "current_usename=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                document.cookie = "current_password=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            });

            function appendnotice(msg) {
                var newdiv = $('<div class="message"></div>').text(msg);
                $('#messages').append(newdiv);
                var body = document.getElementById("body");
                var his = document.getElementById("message_history");
                body.scrollTop = body.scrollHeight;
                his.scrollTop = his.scrollHeight;
            }

            function AppendMessage(data) {
                if (data.u_name == name) {
                    var newdiv = $('<div class="tooltip my_message"></div>')
                        .prop("title", data.u_time)
                        .text(data.u_word);
                    var msg = data.u_name + ":";
                    var whosays = $('<div class="my_says"></div>').text(msg);
                } else {
                    var newdiv = $('<div class="tooltip other_message"></div>')
                        .prop("title", data.u_time)
                        .text(data.u_word);
                    var msg = data.u_name + ":";
                    var whosays = $('<div class="other_says"></div>').text(msg);
                }
                $('#messages').append(whosays);
                $('#messages').append(newdiv);
                $('.tooltip').tooltipster();

                var body = document.getElementById("body");
                var his = document.getElementById("message_history");
                body.scrollTop = body.scrollHeight;
                his.scrollTop = his.scrollHeight;
            }

            function login() {
                if (getCookie("loggedIn") == 1) {
                    name = getCookie("current_username");
                    password = getCookie("current_password");

                    socket.emit("user login", {
                        username: name,
                        userpassword: password
                    });
                } else {
                    name = prompt("請輸入帳號（或輸入guest以訪客登入）\n第一次登入的帳密會自動註冊", "guest");
                    if (name == "" || name == null || name == "guest") {
                        name = "guest";
                        socket.emit("guest login");
                    }
                    if (name != "guest") {
                        var password = prompt("請輸入密碼", "");
                        document.cookie = 'current_username=' + name + ';path=/';
                        document.cookie = "loggedIn=1; path=/";
                        while (password === "" || password === null) {
                            password = prompt("no password!!!", "");
                        }
                        document.cookie = 'current_password=' + password + ';path=/';
                        socket.emit("user login", {
                            username: name,
                            userpassword: password //profile
                        });
                    }
                }
            };





            function updateuserlist(userlist) {
                const list = document.getElementById('userlist');
                list.innerHTML = '';

                for (let i = 0; i < userlist.length; i += 1) {
                    const item = document.createElement('li');
                    if (userlist[i] === name) {
                        item.innerHTML = userlist[i] + "(You)";
                    } else {
                        item.innerHTML = userlist[i];
                    }
                    item.addEventListener('mouseenter', function() {
                        item.style.color = "red";
                    });
                    item.addEventListener('mouseleave', function() {
                        item.style.color = "black";
                    });
                    item.addEventListener('click', function() {
                        socket.emit('private chat', userlist[i]); //when click mouse, private chat
                    });
                    list.appendChild(item);
                }
            };
        });
    </script>
</body>

</html>